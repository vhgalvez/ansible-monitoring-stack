# playbook/01_install_monitoring_stack.yml
- name: ğŸ§± Instalar stack de monitoreo (Prometheus + Grafana)
  hosts: controller
  become: true
  gather_facts: false
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
    KUBECONFIG: "/home/victory/.kube/config"

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    prometheus_chart_version: "27.11.0"
    prometheus_values_path: "/tmp/values-prometheus.yaml"
    grafana_chart_version: "8.12.1"
    grafana_values_path: "/tmp/values-grafana.yaml"
    prometheus_auth_user: "admin"
    prometheus_auth_pass: "admin123"
    grafana_auth_user: "admin"
    grafana_auth_pass: "admin123"

  tasks:
    - name: âœ… Verificar que kubectl estÃ¡ disponible
      command: "/usr/local/bin/kubectl version --client"
      register: kubectl_check
      failed_when: kubectl_check.rc != 0
      changed_when: false

    - name: ğŸ“ Verificar si namespace 'monitoring' existe
      command: kubectl get namespace monitoring
      register: monitoring_namespace
      failed_when: false
      changed_when: false

    - name: ğŸ“ Crear namespace 'monitoring' si no existe
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: monitoring
      when: monitoring_namespace.rc != 0

    # GeneraciÃ³n de hash para Prometheus y Grafana
    - name: ğŸ” Generar hash htpasswd para Prometheus
      delegate_to: localhost
      run_once: true
      command: >
        python3 -c "import crypt; print('{{ prometheus_auth_user }}:' + crypt.crypt('{{ prometheus_auth_pass }}', crypt.mksalt(crypt.METHOD_MD5)))"
      register: prometheus_htpasswd_output

    - name: ğŸ” Crear Secret de autenticaciÃ³n para Prometheus
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: monitoring
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: prometheus-basic-auth
          type: Opaque
          data:
            auth: "{{ prometheus_htpasswd_output.stdout | b64encode }}"

    - name: ğŸ” Generar hash htpasswd para Grafana
      delegate_to: localhost
      run_once: true
      command: >
        python3 -c "import crypt; print('{{ grafana_auth_user }}:' + crypt.crypt('{{ grafana_auth_pass }}', crypt.mksalt(crypt.METHOD_MD5)))"
      register: grafana_htpasswd_output

    - name: ğŸ” Crear Secret de autenticaciÃ³n para Grafana
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: monitoring
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: grafana-basic-auth
          type: Opaque
          data:
            auth: "{{ grafana_htpasswd_output.stdout | b64encode }}"

    # ConfiguraciÃ³n y despliegue de Prometheus y Grafana con Helm
    - name: ğŸ”— Configurar repositorios Helm
      block:
        - name: AÃ±adir repo Prometheus
          command: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          register: prometheus_repo
          failed_when: prometheus_repo.rc != 0 and "exists" not in prometheus_repo.stderr
          changed_when: false

        - name: AÃ±adir repo Grafana
          command: helm repo add grafana https://grafana.github.io/helm-charts
          register: grafana_repo
          failed_when: grafana_repo.rc != 0 and "exists" not in grafana_repo.stderr
          changed_when: false

        - name: ğŸ”„ Actualizar repos Helm
          command: helm repo update
          changed_when: false

    - name: ğŸ“„ Renderizar valores de Prometheus
      template:
        src: helm/prometheus/values-prometheus.yaml.j2
        dest: "{{ prometheus_values_path }}"

    - name: ğŸš€ Desplegar Prometheus con Helm
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        name: prometheus
        chart_ref: prometheus-community/prometheus
        release_namespace: monitoring
        chart_version: "{{ prometheus_chart_version }}"
        create_namespace: false
        values_files:
          - "{{ prometheus_values_path }}"
        state: present

    - name: ğŸ“„ Renderizar valores de Grafana
      template:
        src: helm/grafana/values-grafana.yaml.j2
        dest: "{{ grafana_values_path }}"

    - name: ğŸš€ Desplegar Grafana con Helm
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        name: grafana
        chart_ref: grafana/grafana
        release_namespace: monitoring
        chart_version: "{{ grafana_chart_version }}"
        create_namespace: false
        values_files:
          - "{{ grafana_values_path }}"
        state: present

    - name: ğŸ“† Esperar a que los pods estÃ©n listos
      shell: kubectl get pods -n monitoring
      register: pod_status
      retries: 10
      delay: 6
      until: pod_status.rc == 0
      changed_when: false

    - name: ğŸ” Mostrar estado de los pods
      debug:
        var: pod_status.stdout_lines

    - name: âœ… ConfirmaciÃ³n final
      debug:
        msg: "âœ… Stack Prometheus + Grafana desplegado con Ã©xito con protecciÃ³n bÃ¡sica activada en ambos servicios."