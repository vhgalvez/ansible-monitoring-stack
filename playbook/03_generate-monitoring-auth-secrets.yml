# playbook\03_generate-monitoring-auth-secrets.yml
---
- name: ðŸ” Generar y sellar los Secrets basic-auth (Prometheus + Grafana)
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml # â† tus variables globales

  vars:
    files_dir: "{{ playbook_dir }}/files"
    # Ruta de la plantilla genÃ©rica de Secret
    basic_auth_template: "{{ playbook_dir }}/../templates/secret/basic-auth-secret.yaml.j2"

    # DefiniciÃ³n de los dos Secrets a crear
    secrets:
      - name: prometheus
        user: "{{ prometheus_auth_user }}"
        pass: "{{ prometheus_auth_pass }}"
        secret_name: "{{ prometheus_secret_name }}"
        sealed_path: "{{ files_dir }}/prometheus-dashboard-sealed.yaml"
        unsealed_path: "{{ files_dir }}/prometheus-dashboard-unsealed.yaml"
      - name: grafana
        user: "{{ grafana_auth_user }}"
        pass: "{{ grafana_auth_pass }}"
        secret_name: "{{ grafana_secret_name }}"
        sealed_path: "{{ files_dir }}/grafana-dashboard-sealed.yaml"
        unsealed_path: "{{ files_dir }}/grafana-dashboard-unsealed.yaml"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Comprobaciones previas
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“‹ Verificar que kubeseal estÃ© instalado
      stat:
        path: "{{ kubeseal_path }}"
      register: kubeseal_check

    - name: âŒ Abortamos si kubeseal no estÃ¡
      fail:
        msg: "âŒ kubeseal no estÃ¡ instalado en {{ kubeseal_path }}."
      when: not kubeseal_check.stat.exists

    - name: ðŸ“‹ Verificar que htpasswd estÃ© disponible
      command: which htpasswd
      register: htpasswd_check
      changed_when: false
      failed_when: htpasswd_check.rc != 0

    - name: ðŸ›‘ Abortamos si faltan credenciales bÃ¡sicas
      fail:
        msg: "âŒ Faltan variables grafana_auth_* o prometheus_auth_*"
      when: >
        grafana_auth_user  | default('') | length == 0 or
        grafana_auth_pass  | default('') | length == 0 or
        prometheus_auth_user | default('') | length == 0 or
        prometheus_auth_pass | default('') | length == 0

    - name: âœ… Verificar que monitoring_namespace estÃ¡ definido
      assert:
        that:
          - monitoring_namespace is defined
          - monitoring_namespace | length > 0
        fail_msg: "âŒ La variable 'monitoring_namespace' no estÃ¡ definida o estÃ¡ vacÃ­a."

    - name: ðŸ“‚ Crear carpeta para archivos secretos
      file:
        path: "{{ files_dir }}"
        state: directory
        mode: "0700"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Generar / sellar / aplicar Secrets (loop)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ” Generar, sellar y aplicar los Secrets
      include_tasks: tasks/generate_sealed_secret_inline.yml
      loop: "{{ secrets }}"
      loop_control:
        loop_var: item

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Renderizar y aplicar Middleware
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“„ Renderizar Middleware de Grafana
      template:
        src: "{{ playbook_dir }}/../templates/secret/grafana_middleware.yaml.j2"
        dest: "{{ files_dir }}/grafana-middleware.yaml"

    - name: ðŸ“„ Renderizar Middleware de Prometheus
      template:
        src: "{{ playbook_dir }}/../templates/secret/prometheus_middleware.yaml.j2"
        dest: "{{ files_dir }}/prometheus-middleware.yaml"

    - name: ðŸš€ Aplicar Middleware de Grafana
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ files_dir }}/grafana-middleware.yaml
      changed_when: false

    - name: ðŸš€ Aplicar Middleware de Prometheus
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ files_dir }}/prometheus-middleware.yaml
      changed_when: false
