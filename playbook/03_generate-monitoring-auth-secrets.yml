# ðŸ” Generar y sellar los Secrets de autenticaciÃ³n bÃ¡sica para Prometheus y Grafana
- name: ðŸ” Generar y sellar los Secrets de basic-auth para Prometheus y Grafana
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml  # Variables definidas desde el archivo vars/main.yml

  vars:
    files_dir: "{{ playbook_dir }}/files"
    prometheus_secret_template: "../templates/secret/basic-auth-secret.yaml.j2"
    grafana_secret_template: "../templates/secret/basic-auth-secret.yaml.j2"
    prometheus_unsealed_path: "{{ files_dir }}/prometheus-dashboard-secret-unsealed.yaml"
    grafana_unsealed_path: "{{ files_dir }}/grafana-dashboard-secret-unsealed.yaml"
    prometheus_sealed_path: "{{ files_dir }}/prometheus-dashboard-sealed.yaml"
    grafana_sealed_path: "{{ files_dir }}/grafana-dashboard-sealed.yaml"

  tasks:
    - name: ðŸ“‹ Verificar que kubeseal estÃ© instalado
      stat:
        path: "{{ kubeseal_path }}"
      register: kubeseal_check

    - name: âŒ Abortar si kubeseal no estÃ¡ instalado
      fail:
        msg: "kubeseal no estÃ¡ instalado en {{ kubeseal_path }}"
      when: not kubeseal_check.stat.exists

    - name: ðŸ“‹ Verificar que htpasswd estÃ© disponible
      command: which htpasswd
      register: htpasswd_check
      failed_when: htpasswd_check.rc != 0
      changed_when: false

    # ðŸš¨ VerificaciÃ³n explÃ­cita de variables
    - name: âš ï¸ Mostrar valores de usuario y contraseÃ±a si estÃ¡n vacÃ­os
      debug:
        msg:
          - "âš ï¸ grafana_auth_user = {{ grafana_auth_user | default('undefined') }}"
          - "âš ï¸ grafana_auth_pass = {{ grafana_auth_pass | default('undefined') }}"
          - "âš ï¸ prometheus_auth_user = {{ prometheus_auth_user | default('undefined') }}"
          - "âš ï¸ prometheus_auth_pass = {{ prometheus_auth_pass | default('undefined') }}"

    - name: ðŸ›‘ Abortamos si faltan variables requeridas
      fail:
        msg: "âŒ Faltan variables prometheus_auth_user/pass o grafana_auth_user/pass"
      when: 
        - grafana_auth_user is not defined or grafana_auth_user == ""
        - grafana_auth_pass is not defined or grafana_auth_pass == ""
        - prometheus_auth_user is not defined or prometheus_auth_user == ""
        - prometheus_auth_pass is not defined or prometheus_auth_pass == ""

    # ðŸ”‘ Generar htpasswd para Prometheus
    - name: ðŸ”‘ Generar htpasswd para Prometheus
      shell: echo "{{ prometheus_auth_pass }}" | htpasswd -i -B -n "{{ prometheus_auth_user }}"
      register: prometheus_htpasswd
      changed_when: false

    # ðŸ”‘ Generar htpasswd para Grafana
    - name: ðŸ”‘ Generar htpasswd para Grafana
      shell: echo "{{ grafana_auth_pass }}" | htpasswd -i -B -n "{{ grafana_auth_user }}"
      register: grafana_htpasswd
      changed_when: false

    # âž• Codificar ambos en base64
    - name: âž• Codificar Prometheus htpasswd en base64
      set_fact:
        prometheus_basic_auth: "{{ prometheus_htpasswd.stdout | b64encode }}"

    - name: âž• Codificar Grafana htpasswd en base64
      set_fact:
        grafana_basic_auth: "{{ grafana_htpasswd.stdout | b64encode }}"

    # ðŸ“ Crear carpeta temporal
    - name: ðŸ“‚ Asegurar directorio temporal
      file:
        path: "{{ files_dir }}"
        state: directory
        mode: "0700"

    # ðŸ“„ Renderizar Secret plano para Prometheus
    - name: ðŸ“„ Renderizar Secret plano para Prometheus
      template:
        src: "{{ prometheus_secret_template }}"
        dest: "{{ prometheus_unsealed_path }}"
      vars:
        basic_auth: "{{ prometheus_basic_auth }}"
        namespace_tpl: "{{ monitoring_namespace }}"
        secret_name: "{{ prometheus_secret_name }}"

    # ðŸ“„ Renderizar Secret plano para Grafana
    - name: ðŸ“„ Renderizar Secret plano para Grafana
      template:
        src: "{{ grafana_secret_template }}"
        dest: "{{ grafana_unsealed_path }}"
      vars:
        basic_auth: "{{ grafana_basic_auth }}"
        namespace_tpl: "{{ monitoring_namespace }}"
        secret_name: "{{ grafana_secret_name }}"

    # ðŸ” Sellar con kubeseal
    - name: ðŸ” Sellar Secret de Prometheus
      shell: >
        {{ kubeseal_path }} --controller-name sealed-secrets-controller
        --controller-namespace kube-system --format yaml
        < {{ prometheus_unsealed_path }} > {{ prometheus_sealed_path }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: ðŸ” Sellar Secret de Grafana
      shell: >
        {{ kubeseal_path }} --controller-name sealed-secrets-controller
        --controller-namespace kube-system --format yaml
        < {{ grafana_unsealed_path }} > {{ grafana_sealed_path }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    # â™»ï¸ Limpiar temporales
    - name: â™»ï¸ Limpiar secretos planos
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ prometheus_unsealed_path }}"
        - "{{ grafana_unsealed_path }}"

    # ðŸš€ Aplicar Secrets sellados
    - name: ðŸš€ Aplicar Secret sellado de Prometheus
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ prometheus_sealed_path }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: ðŸš€ Aplicar Secret sellado de Grafana
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ grafana_sealed_path }}
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"