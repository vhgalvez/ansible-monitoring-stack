# playbook\03_generate-monitoring-auth-secrets.yml
---
# ðŸ” Genera y aplica Secrets + Middlewares (Prometheus & Grafana)
- name: ðŸ” Generar y sellar los Secrets basic-auth (Prometheus + Grafana)
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    files_dir: "{{ playbook_dir }}/files"

    secrets:
      - name: prometheus
        user: "{{ prometheus_auth_user }}"
        pass: "{{ prometheus_auth_pass }}"
        secret_name: "{{ prometheus_secret_name }}"
        sealed_path: "{{ files_dir }}/prometheus-dashboard-sealed.yaml"
        unsealed_path: "{{ files_dir }}/prometheus-dashboard-unsealed.yaml"

      - name: grafana
        user: "{{ grafana_auth_user }}"
        pass: "{{ grafana_auth_pass }}"
        secret_name: "{{ grafana_secret_name }}"
        sealed_path: "{{ files_dir }}/grafana-dashboard-sealed.yaml"
        unsealed_path: "{{ files_dir }}/grafana-dashboard-unsealed.yaml"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Validaciones previas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“‹ Verificar que kubeseal estÃ¡ instalado
      stat: { path: "{{ kubeseal_path }}" }
      register: kubeseal_chk

    - name: âŒ Salir si kubeseal no estÃ¡ presente
      fail:
        msg: "kubeseal no encontrado en {{ kubeseal_path }}."
      when: not kubeseal_chk.stat.exists

    - name: ðŸ“‹ Verificar que htpasswd estÃ¡ disponible
      command: which htpasswd
      register: ht_chk
      changed_when: false
      failed_when: ht_chk.rc != 0

    - name: ðŸ›‘ Validar credenciales de entorno
      assert:
        that:
          - grafana_auth_user  | length > 0
          - grafana_auth_pass  | length > 0
          - prometheus_auth_user | length > 0
          - prometheus_auth_pass | length > 0
        fail_msg: "Faltan variables *_AUTH_* requeridas."

    - name: âœ… Asegurar que monitoring_namespace estÃ¡ definido
      assert:
        that: monitoring_namespace | length > 0
        fail_msg: "monitoring_namespace vacÃ­o o indefinido."

    - name: ðŸ“‚ Crear carpeta local de archivos sellados
      file:
        path: "{{ files_dir }}"
        state: directory
        mode: "0700"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Generar & aplicar Secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ” Generar / sellar / aplicar cada Secret
      include_tasks: tasks/generate_sealed_secret_inline.yml
      loop: "{{ secrets }}"
      loop_control: { loop_var: item }

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Middlewares â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ðŸ“„ Renderizar Middlewares basicAuth
      template:
        src: "secret/{{ item.name }}_middleware.yaml.j2"
        dest: "{{ files_dir }}/{{ item.name }}-middleware.yaml"
      loop:
        - { name: prometheus }
        - { name: grafana }
      loop_control: { label: "{{ item.name }}" }

    - name: ðŸš€ Aplicar Middlewares al clÃºster
      command: >
        {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ item }}
      loop:
        - "{{ files_dir }}/prometheus-middleware.yaml"
        - "{{ files_dir }}/grafana-middleware.yaml"
      changed_when: false
