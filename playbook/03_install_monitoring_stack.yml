---
# playbook/03_install_monitoring_stack.yml
# 3ï¸âƒ£ Instalar Prometheus y Grafana con Helm y almacenamiento persistente

- name: ğŸ§± Instalar stack de monitoreo (Prometheus + Grafana)
  hosts: controller
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    force_install: false

  tasks:
    - name: ğŸ“ Crear namespace monitoring si no existe
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: false
        api_version: v1
        kind: Namespace
        name: monitoring
        state: present
      environment: "{{ grafana_env }}"

    - name: ğŸ” Verificar si Prometheus ya estÃ¡ instalado
      kubernetes.core.helm_info:
        kubeconfig: "{{ kubeconfig_path }}"
        name: prometheus
        namespace: monitoring
        validate_certs: false
      register: prometheus_installed
      ignore_errors: true
      environment: "{{ grafana_env }}"

    - name: ğŸ” Verificar si Grafana ya estÃ¡ instalado
      kubernetes.core.helm_info:
        kubeconfig: "{{ kubeconfig_path }}"
        name: grafana
        namespace: monitoring
        validate_certs: false
      register: grafana_installed
      ignore_errors: true
      environment: "{{ grafana_env }}"

    - name: ğŸš€ Instalar o forzar reinstalaciÃ³n de Prometheus
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: false
        name: prometheus
        chart_ref: prometheus-community/prometheus
        release_namespace: monitoring
        create_namespace: false
        state: present
        values:
          persistence:
            enabled: true
            existingClaim: prometheus-pvc
      when: force_install | bool or prometheus_installed.failed
      environment: "{{ grafana_env }}"

    - name: ğŸš€ Instalar o forzar reinstalaciÃ³n de Grafana
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: false
        name: grafana
        chart_ref: grafana/grafana
        release_namespace: monitoring
        create_namespace: false
        state: present
        values:
          persistence:
            enabled: true
            existingClaim: grafana-pvc
          adminPassword: "{{ grafana_admin_password | default('admin123') }}"
          service:
            type: ClusterIP
      when: force_install | bool or grafana_installed.failed
      environment: "{{ grafana_env }}"

    - name: âœ… Mostrar mensaje final
      debug:
        msg: "âœ… Prometheus y Grafana se han instalado correctamente (o forzadamente reinstalados si se indicÃ³)."