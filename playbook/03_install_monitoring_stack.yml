---
# playbook\03_install_monitoring_stack.yml
# InstalaciÃ³n de un stack de monitoreo (Prometheus + Grafana) en un clÃºster de Kubernetes utilizando Helm Charts.
- name: ğŸ§± Instalar stack de monitoreo (Prometheus + Grafana)
  hosts: controller
  gather_facts: false
  become: true
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    prometheus_service_port: "{{ prometheus_port }}" # Puerto para Prometheus
    grafana_service_port: "{{ grafana_service_port }}" # Puerto para Grafana

  tasks:
    - name: ğŸ“ Asegurar namespace 'monitoring'
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: false
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: monitoring

    - name: ğŸ”— AÃ±adir repositorios Helm
      block:
        - name: AÃ±adir repo Prometheus
          ansible.builtin.command: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          register: prometheus_repo
          failed_when: prometheus_repo.rc != 0 and "exists" not in prometheus_repo.stderr
          changed_when: "'has been added' in prometheus_repo.stdout"

        - name: AÃ±adir repo Grafana
          ansible.builtin.command: helm repo add grafana https://grafana.github.io/helm-charts
          register: grafana_repo
          failed_when: grafana_repo.rc != 0 and "exists" not in grafana_repo.stderr
          changed_when: "'has been added' in grafana_repo.stdout"

        - name: ğŸ”„ Actualizar repositorios Helm
          ansible.builtin.command: helm repo update

    - name: ğŸ DEBUG - Verificar prometheus_container_port ANTES de renderizar
      ansible.builtin.debug:
        var: prometheus_container_port
      tags: always # Asegura que se ejecute siempre

    - name: ğŸ“„ Renderizar values para Prometheus
      ansible.builtin.template:
        src: helm/prometheus/values-prometheus.yaml.j2
        dest: /tmp/values-prometheus.yaml

    - name: ğŸš€ Instalar Prometheus con Helm
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        name: prometheus
        chart_ref: prometheus-community/prometheus
        release_namespace: monitoring
        create_namespace: false
        values_files:
          - /tmp/values-prometheus.yaml
        state: present

    - name: ğŸ“„ Renderizar values para Grafana
      ansible.builtin.template:
        src: helm/grafana/values-grafana.yaml.j2
        dest: /tmp/values-grafana.yaml

    - name: ğŸš€ Instalar Grafana con Helm
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        name: grafana
        chart_ref: grafana/grafana
        release_namespace: monitoring
        create_namespace: false
        values_files:
          - /tmp/values-grafana.yaml
        state: present

    - name: âœ… ConfirmaciÃ³n final
      debug:
        msg: "âœ… Prometheus y Grafana instalados correctamente con almacenamiento persistente y Helm Charts."
