---
# playbook\03_install_monitoring_stack.yml
# 3️⃣ Instalar Prometheus y Grafana con Helm y almacenamiento persistente

- name: 🧱 Instalar stack de monitoreo (Prometheus + Grafana)
  hosts: localhost
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    grafana_env:
      PATH: "/usr/local/bin:/usr/bin:/bin"

  tasks:
    - name: 🔍 Verificar si Prometheus ya está instalado
      kubernetes.core.helm_info:
        kubeconfig: "{{ kubeconfig_path }}"
        name: prometheus
        namespace: monitoring
        validate_certs: false
      register: prometheus_installed
      ignore_errors: true
      environment: "{{ grafana_env }}"

    - name: 🔍 Verificar si Grafana ya está instalado
      kubernetes.core.helm_info:
        kubeconfig: "{{ kubeconfig_path }}"
        name: grafana
        namespace: monitoring
        validate_certs: false
      register: grafana_installed
      ignore_errors: true
      environment: "{{ grafana_env }}"

    - name: 🚀 Instalar Prometheus vía Helm si no está instalado
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: false
        name: prometheus
        chart_ref: prometheus-community/prometheus
        release_namespace: monitoring
        create_namespace: false
        values:
          persistence:
            enabled: true
            existingClaim: prometheus-pvc
      when: prometheus_installed.failed
      environment: "{{ grafana_env }}"

    - name: 🚀 Instalar Grafana vía Helm si no está instalado
      kubernetes.core.helm:
        kubeconfig: "{{ kubeconfig_path }}"
        validate_certs: false
        name: grafana
        chart_ref: grafana/grafana
        release_namespace: monitoring
        create_namespace: false
        values:
          persistence:
            enabled: true
            existingClaim: grafana-pvc
          adminPassword: "{{ grafana_admin_password }}"
          service:
            type: ClusterIP
      when: grafana_installed.failed
      environment: "{{ grafana_env }}"

    - name: ✅ Mostrar mensaje final
      debug:
        msg: "✅ Prometheus y Grafana se han instalado correctamente (si no lo estaban ya)."
