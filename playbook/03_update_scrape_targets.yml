# playbook/03_update_scrape_targets.yml
---
# ğŸ”„ Actualizar los targets de scrape de Prometheus para nodos externos (Node Exporter)

- name: ğŸ”„ Actualizar targets de scrape en Prometheus
  hosts: controller
  become: true
  gather_facts: false

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    prometheus_extra_scrape_config_path: "/tmp/extraScrapeConfigs.yaml"

  tasks:
    - name: ğŸ“‚ Verificar si el archivo de configuraciÃ³n extraScrapeConfigs.yaml existe
      stat:
        path: "{{ prometheus_extra_scrape_config_path }}"
      register: scrape_config_stat

    - name: ğŸ”„ Si el archivo extraScrapeConfigs.yaml existe, actualizar configuraciÃ³n de scraping en Prometheus
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: merged
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: prometheus-server
            namespace: monitoring
          data:
            extraScrapeConfigs.yaml: "{{ lookup('file', prometheus_extra_scrape_config_path) }}"
      when: scrape_config_stat.stat.exists

    - name: ğŸ” Si el archivo extraScrapeConfigs.yaml no existe, mostrar un mensaje
      debug:
        msg: "El archivo extraScrapeConfigs.yaml no existe, no se actualizÃ³ la configuraciÃ³n de scrape."
      when: not scrape_config_stat.stat.exists

    - name: âœ… ConfirmaciÃ³n final
      debug:
        msg: "ğŸ‰ Targets de scrape actualizados exitosamente en Prometheus."

- name: Asegurarse de que los hechos de Ansible se recopilen
  ansible.builtin.setup:
    gather_subset:
      - network  # Solo se recopila informaciÃ³n relacionada con la red
  when: ansible_facts is not defined