---
# playbook/03_update_scrape_targets.yml
# 🎯 Actualiza las máquinas externas que serán monitoreadas por Prometheus

- name: 🔄 Actualizar objetivos de scrape para Prometheus
  hosts: controller
  gather_facts: false
  become: true

  vars:
    kubeconfig_path: "/home/victory/.kube/config"

  tasks:

    - name: 📄 Renderizar archivo extraScrapeConfigs.yaml
      ansible.builtin.template:
        src: playbook/templates/node_exporter/extraScrapeConfigs.yaml.j2
        dest: /tmp/extraScrapeConfigs.yaml

    - name: 🔐 Crear o actualizar Secret de Prometheus con extraScrapeConfigs
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: monitoring
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: prometheus-additional-scrape-configs
          type: Opaque
          data:
            extraScrapeConfigs.yaml: "{{ lookup('file', '/tmp/extraScrapeConfigs.yaml') | b64encode }}"

    - name: 🔁 Reiniciar pods de Prometheus para aplicar nuevos targets
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: monitoring
        kind: Deployment
        name: prometheus-server
        state: present
        definition:
          spec:
            template:
              metadata:
                annotations:
                  kubectl.kubernetes.io/restartedAt: "{{ lookup('pipe', 'date +%Y-%m-%dT%H:%M:%S') }}"