# playbook/03_update_scrape_targets.yml
# 🎯 Actualiza las máquinas externas que serán monitoreadas por Prometheus

- name: 🔄 Actualizar objetivos de scrape para Prometheus
  hosts: controller
  gather_facts: false
  become: true
  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    node_exporter_port: 9100

  tasks:
    - name: 📄 Renderizar archivo extraScrapeConfigs.yaml
      ansible.builtin.template:
        src: templates/node_exporter/extraScrapeConfigs.yaml.j2
        dest: /tmp/extraScrapeConfigs.yaml

    - name: 🔐 Crear o actualizar Secret de Prometheus con extraScrapeConfigs
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: monitoring
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: prometheus-additional-scrape-configs
          type: Opaque
          data:
            extraScrapeConfigs.yaml: "{{ lookup('file', '/tmp/extraScrapeConfigs.yaml') | b64encode }}"

    - name: 🔁 Forzar reinicio del Deployment de Prometheus
      shell: >
        kubectl rollout restart deployment prometheus-server -n monitoring
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"

    - name: 📦 Verificar estado de pods en namespace monitoring
      shell: kubectl get pods -n monitoring
      register: pods_status
      changed_when: false

    - name: 🔍 Mostrar resultado del estado de los pods
      debug:
        var: pods_status.stdout_lines