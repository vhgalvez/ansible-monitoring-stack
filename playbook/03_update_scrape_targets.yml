# playbook/03_update_scrape_targets.yml
---
- name: ðŸ”„ Actualizar targets de scrape en Prometheus
  hosts: controller
  become: true
  gather_facts: false

  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    prometheus_extra_scrape_config_path: "/tmp/extraScrapeConfigs.yaml"

  tasks:
    - name: ðŸ“‚ Verificar si el archivo de configuraciÃ³n extraScrapeConfigs.yaml existe
      stat:
        path: "{{ prometheus_extra_scrape_config_path }}"
      register: scrape_config_stat

    - name: ðŸ”„ Si el archivo extraScrapeConfigs.yaml existe, actualizar configuraciÃ³n de scraping en Prometheus
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig_path }}"
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: prometheus-server
            namespace: monitoring
          data:
            extraScrapeConfigs.yaml: "{{ lookup('file', prometheus_extra_scrape_config_path) }}"
      when: scrape_config_stat.stat.exists

    - name: âœ… ConfirmaciÃ³n final
      debug:
        msg: "ðŸŽ‰ Targets de scrape actualizados exitosamente en Prometheus."