# playbook/05_update_scrape_targets.yml
# 5️⃣ Generar configuración de scraping para nodos externos (extraScrapeConfigs.yaml)

- name: 📄 Generar archivo de scrape dinámico para nodos externos
  hosts: controller
  connection: local
  gather_facts: false

  vars:
    output_path: "/tmp/prometheus_manifests/extraScrapeConfigs.yaml"
    template_src: "{{ playbook_dir }}/roles/node_exporter/templates/extraScrapeConfigs.yaml.j2"  # Ruta actualizada

  tasks:
    - name: 📁 Crear carpeta para manifests si no existe
      file:
        path: "{{ output_path | dirname }}"
        state: directory
        mode: '0755'

    - name: 🧩 Renderizar plantilla extraScrapeConfigs.yaml
      template:
        src: "{{ template_src }}"
        dest: "{{ output_path }}"
        mode: '0644'

    - name: 📜 Mostrar resumen de ruta generada
      debug:
        msg: "✅ Archivo de scrapes generado en {{ output_path }}"

    # (Opcional) Aplicar configuración como Secret en Kubernetes
    - name: 🛠️ Aplicar configuración de scraping como un Secret en Kubernetes
      command: >
        kubectl create secret generic prometheus-additional-scrape-configs \
          --from-file=extraScrapeConfigs.yaml={{ output_path }} \
          --namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: "/home/victory/.kube/config"