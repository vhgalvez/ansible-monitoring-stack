# playbook/deploy_monitoring_stack.yml
---
- name: 🧩 Cargar variables de configuración desde main.yml
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Cargar variables de configuración
      debug:
        msg: "Variables cargadas correctamente desde vars/main.yml"

- name: Instalar stack de monitoreo (Prometheus + Grafana)
  import_playbook: 01_install_monitoring_stack.yml

- name: Instalar Node Exporter en máquinas externas (si aplica)
  import_playbook: 02_install_node_exporter.yml

- name: Generar y sellar los Secrets de autenticación básica para Prometheus y Grafana
  import_playbook: 03_generate-monitoring-auth-secrets.yml

- name: Verificación final del despliegue de Prometheus y Grafana
  hosts: localhost
  gather_facts: false

  vars_files:
    - ../vars/main.yml

  tasks:
    - name: ⏳ Esperar a que Grafana y Prometheus-server estén listos
  retries: 20 # ≃ 5 min
  delay: 15
  vars:
    ready_pods: >-
      {{ pod_status.resources
         | json_query(
             "[?status.phase=='Running' && "
             "length(status.containerStatuses[?ready==`false`])==`0`]"
           )
      }}
  until: ready_pods | length >= 2 # Grafana + Prometheus-server
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    namespace: "{{ monitoring_namespace }}"
    kind: Pod
    label_selectors:
      - "app.kubernetes.io/instance in (grafana,prometheus)"
  register: pod_status
  changed_when: false
