---
# üß© deploy_monitoring_stack.yml
# Playbook maestro para desplegar el stack de monitoreo completo en Kubernetes.
# Compatible con ejecuci√≥n local, CI/CD y automatizaci√≥n general.

- name: Cargar variables de vars/main.yml y ejecutar playbooks en 'controller'
  vars_files:
    vars/main.yml
  hosts: localhost

# 1 Desplegar stack de monitoreo completo (Prometheus + Grafana)
- name: 1 Desplegar stack de monitoreo completo (Prometheus + Grafana)
  import_playbook: 01_install_monitoring_stack.yml

# 2 Crear y cifrar los secrets de autenticaci√≥n para Prometheus y Grafana
- name: 2 Crear y cifrar los secrets de autenticaci√≥n para Prometheus y Grafana
  import_playbook: seal-monitoring-auth-secret.yml

# 3 Instalar Node Exporter en m√°quinas externas (si aplica)
- name: 3 Instalar Node Exporter en m√°quinas externas (si aplica)
  import_playbook: 02_install_node_exporter.yml

# 4 Verificaci√≥n del despliegue y estado de los pods
- name: 4 Verificaci√≥n final del despliegue
  hosts: localhost
  gather_facts: false
  tasks:
    - name: ‚úÖ Verificar que los pods est√©n listos
      shell: kubectl get pods -n monitoring
      register: pod_status
      retries: 10
      delay: 6
      until: pod_status.rc == 0
      changed_when: false

    - name: üîç Mostrar estado de los pods
      debug:
        var: pod_status.stdout_lines

    - name: ‚úÖ Confirmaci√≥n final
      debug:
        msg: "‚úÖ Stack Prometheus + Grafana desplegado con √©xito con protecci√≥n b√°sica activada en ambos servicios."