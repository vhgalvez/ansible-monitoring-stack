---
---
# üß© deploy_monitoring_stack.yml
# Playbook maestro para desplegar el stack de monitoreo completo en Kubernetes.
# Compatible con ejecuci√≥n local, CI/CD y automatizaci√≥n general.

- name: Cargar variables de group_vars y ejecutar playbooks en 'controller'
  hosts: controller  # Especifica que las tareas se ejecutar√°n en el grupo 'controller'
  vars_files:
    - group_vars/all.yml  # Carga el archivo de variables

  tasks:
    - name: 1Ô∏è‚É£ Instalar herramientas locales necesarias (kubectl, pip, helm)
      import_playbook: 01_install_local_tools.yml

    - name: 2Ô∏è‚É£ Configurar kubeconfig desde master con acceso por VIP
      import_playbook: 02_setup_kubeconfig.yml

    - name: 3Ô∏è‚É£ Desplegar stack de monitoreo completo (Prometheus + Grafana)
      import_playbook: 03_install_monitoring_stack.yml
      vars:
        prometheus_container_port: "{{ prometheus_container_port }}"
        prometheus_service_port: "{{ prometheus_service_port }}"
        prometheus_storage_class: "{{ prometheus_storage_class }}"
        prometheus_pvc_size: "{{ prometheus_pvc_size }}"
        prometheus_service_type: "{{ prometheus_service_type }}"
        kubeconfig_path: "{{ kubeconfig_path }}"  # Aseg√∫rate de pasar cualquier otra variable necesaria

    - name: 4Ô∏è‚É£ Instalar Node Exporter en m√°quinas externas (si aplica)
      import_playbook: 04_install_node_exporter.yml

    - name: 5Ô∏è‚É£ Generar y aplicar configuraci√≥n de scrapes externos
      import_playbook: 05_update_scrape_targets.yml
