---
# 🧩 deploy_monitoring_stack.yml
# Playbook maestro para desplegar el stack de monitoreo completo en Kubernetes.
# Compatible con ejecución local, CI/CD y automatización general.

- name: Cargar variables de vars/main.yml y ejecutar playbooks en 'controller'
  vars_files:
    - vars/main.yml
  hosts: localhost
  tasks:
    - name: Cargar variables de configuración
      debug:
        msg: "Variables cargadas correctamente desde vars/main.yml"

# 1. Desplegar stack de monitoreo completo (Prometheus + Grafana)
- name: Desplegar stack de monitoreo completo (Prometheus + Grafana)
  import_playbook: 01_install_monitoring_stack.yml # Corrige la ruta aquí

# 2. Instalar Node Exporter en máquinas externas (si aplica)
- name: Instalar Node Exporter en máquinas externas (si aplica)
  import_playbook: 02_install_node_exporter.yml # Corrige la ruta aquí

# 3. Generar y sellar los Secrets de autenticación básica para Prometheus y Grafana
- name: Generar y sellar los Secrets de autenticación básica para Prometheus y Grafana
  import_playbook: 03_generate-monitoring-auth-secrets.yml # Corrige la ruta aquí

# 4. Configurar Prometheus y Grafana con autenticación básica
- name: Configurar Prometheus y Grafana con autenticación básica
  import_playbook: 04_seal-monitoring-auth-secret.yml # Corrige la ruta aquí

# 5. Verificación del despliegue y estado de los pods
- name: Verificación final del despliegue de Prometheus y Grafana
  hosts: localhost
  gather_facts: false
  tasks:
    - name: ✅ Verificar que los pods de Prometheus y Grafana estén listos
      k8s_facts:
        kubeconfig: "{{ kubeconfig_path }}"
        namespace: monitoring
      register: pod_status
      retries: 10
      delay: 6
      until: pod_status.resources | length > 0
      changed_when: false

    - name: 🔍 Mostrar estado de los pods
      debug:
        var: pod_status.resources

    - name: ✅ Confirmación final del despliegue
      debug:
        msg: "✅ Stack Prometheus + Grafana desplegado con éxito con protección básica activada en ambos servicios."
