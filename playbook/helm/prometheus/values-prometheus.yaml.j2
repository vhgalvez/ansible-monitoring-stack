# playbook\helm\prometheus\values-prometheus.yaml.j2
server:
  service:
    type: NodePort  # Changed to NodePort for direct access
    port: 80
    targetPort: 9090
    nodePort: 30090  # You can access via http://<node-ip>:30090
  # Disable ingress temporarily
  ingress:
    enabled: false
  resources:
    requests:
      cpu: "500m"
      memory: "1Gi"
    limits:
      cpu: "1"
      memory: "2Gi"
  serverFiles:
    prometheus.yml:
      global:
        scrape_interval: "15s"
        evaluation_interval: "15s"
      scrape_configs:
        - job_name: 'kubernetes-apiservers'
          kubernetes_sd_configs:
            - role: endpoints
          relabel_configs:
            - source_labels:
                - __meta_kubernetes_namespace
                - __meta_kubernetes_service_name
                - __meta_kubernetes_endpoint_port_name
              action: keep
              regex: "default;kubernetes;https"  # Filtra por el puerto HTTPS de Kubernetes
        - job_name: 'kubernetes-nodes'
          kubernetes_sd_configs:
            - role: node
          relabel_configs:
            - action: labelmap
              regex: "__meta_kubernetes_node_label_(.+)"  # Corrected regex for node labels

# Configuraci√≥n extra de scrape para nodos externos
extraScrapeConfigs: |
  - job_name: 'node-exporter-externos'
    scrape_interval: "15s"
    scrape_timeout: "10s"
    static_configs:
      - targets:
          - "10.17.3.11:9100"
          - "192.168.0.30:9100"
          - "192.168.0.31:9100"
          - "10.17.3.14:9100"
          - "192.168.0.40:9100"
        labels:
          environment: "external"
          monitored_by: "prometheus"

# TLS configuration - only include if you have the variable defined
{% if tls_secret_name is defined %}
tls:
  secretName: {{ tls_secret_name }}
{% endif %}