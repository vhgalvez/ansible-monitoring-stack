# playbook/tasks/generate_sealed_secret_inline.yml

# 🔐 Genera y aplica un Secret sellado para autenticación básica (Traefik)
# Requiere: item.*, basic_auth_template, monitoring_namespace,
#           kubectl_path, kubeseal_path, kubeconfig_path
---

- name: 🔑 Generar hash htpasswd para {{ item.name }}
  shell: |
    htpasswd -nbB {{ item.user | quote }} {{ item.pass | quote }}
  register: htpasswd_output
  changed_when: false
  failed_when: htpasswd_output.rc != 0

- name: ✅ Validar que htpasswd generó salida válida para {{ item.name }}
  assert:
    that:
      - htpasswd_output.stdout is string
      - htpasswd_output.stdout != ""
    fail_msg: "❌ htpasswd no generó salida válida para {{ item.name }}"

- name: ➕ Codificar resultado en base64 para {{ item.name }}
  set_fact:
    basic_auth: "{{ htpasswd_output.stdout | b64encode | regex_replace('\\n', '') }}"

- name: 📄 Renderizar Secret sin cifrar para {{ item.name }}
  template:
    src: "{{ basic_auth_template }}"
    dest: "{{ item.unsealed_path }}"
  vars:
    basic_auth: "{{ basic_auth }}"
    namespace: "{{ monitoring_namespace }}"
    secret_name: "{{ item.secret_name }}"

- name: 🔐 Sellar Secret con kubeseal para {{ item.name }}
  shell: >
    {{ kubeseal_path }}
      --controller-name sealed-secrets-controller
      --controller-namespace kube-system
      --format yaml
      < {{ item.unsealed_path }} > {{ item.sealed_path }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: sealed_output
  changed_when: true
  failed_when: sealed_output.rc != 0

- name: ♻️ Eliminar archivo plano {{ item.unsealed_path }}
  file:
    path: "{{ item.unsealed_path }}"
    state: absent

- name: 🚀 Aplicar Secret sellado al clúster ({{ item.name }})
  command: >
    {{ kubectl_path }} --kubeconfig {{ kubeconfig_path }} apply -f {{ item.sealed_path }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: kubectl_apply
  changed_when: "'configured' in kubectl_apply.stdout or 'created' in kubectl_apply.stdout"

- name: 📄 Renderizar Middlewares basicAuth para {{ item.name }}
  template:
    src: "secret/{{ item.name }}_middleware.yaml.j2"
    dest: "playbook/files/{{ item.name }}-middleware.yaml"
  loop:
    - name: prometheus
      secret_name: "{{ prometheus_secret_name }}"
      middleware_name: "{{ prometheus_dashboard_middleware_name }}"
      namespace: "{{ monitoring_namespace }}"
    - name: grafana
      secret_name: "{{ grafana_secret_name }}"
      middleware_name: "{{ grafana_dashboard_middleware_name }}"
      namespace: "{{ monitoring_namespace }}"
  loop_control:
    label: "{{ item.name }}"