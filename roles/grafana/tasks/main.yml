# roles/grafana/tasks/main.yml
---
- name: 🔗 Añadir repositorio Helm de Grafana
  ansible.builtin.command: helm repo add grafana https://grafana.github.io/helm-charts
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"
  register: grafana_repo
  failed_when: grafana_repo.rc != 0 and "exists" not in grafana_repo.stderr
  changed_when: "'has been added' in grafana_repo.stdout"

- name: 🔄 Actualizar repositorios de Helm
  ansible.builtin.command: helm repo update
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"

- name: 📁 Asegurar que el namespace 'monitoring' existe
  kubernetes.core.k8s:
    kubeconfig: "/home/victory/.kube/config"
    validate_certs: false
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: monitoring

- name: 📦 Crear PersistentVolumeClaim para Grafana
  kubernetes.core.k8s:
    kubeconfig: "/home/victory/.kube/config"
    validate_certs: false
    state: present
    definition: "{{ lookup('template', 'grafana-pvc.yaml.j2') }}"

- name: 🚀 Instalar o actualizar Grafana vía Helm
  kubernetes.core.helm:
    kubeconfig: "/home/victory/.kube/config"
    validate_certs: false
    name: grafana
    chart_ref: grafana/grafana
    release_namespace: monitoring
    create_namespace: false
    values:
      persistence:
        enabled: true
        existingClaim: grafana-pvc
      adminPassword: "{{ grafana_admin_password }}"
      service:
        type: ClusterIP
    state: present  # <-- Asegura que se instale o actualice
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"