
# roles/prometheus/tasks/main.yml

# 1ï¸âƒ£ Crear namespace 'monitoring' si no existe usando kubectl
- name: ğŸ” Verificar si existe namespace monitoring
  command: /usr/local/bin/kubectl get namespace monitoring
  register: ns_monitoring_status
  failed_when: false
  changed_when: false
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

- name: ğŸ“¥ Crear namespace monitoring si no existe
  command: /usr/local/bin/kubectl create namespace monitoring
  when: ns_monitoring_status.rc != 0
  environment:
    KUBECONFIG: "/home/victory/.kube/config"
  register: ns_create_result
  changed_when: "'created' in ns_create_result.stdout"

# 2ï¸âƒ£ AÃ±adir repositorio prometheus-community si no existe
- name: ğŸ”— AÃ±adir repositorio prometheus-community si no existe
  command: /usr/local/bin/helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"
  register: add_repo_result
  failed_when: add_repo_result.rc != 0 and 'exists' not in add_repo_result.stderr
  changed_when: "'has been added' in add_repo_result.stdout"

# 3ï¸âƒ£ Actualizar repositorios de Helm
- name: ğŸ”„ Actualizar repositorios de Helm
  command: /usr/local/bin/helm repo update
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"

# 4ï¸âƒ£ Verificar si el deployment de Prometheus ya existe
- name: ğŸ” Verificar si el deployment de Prometheus existe
  command: /usr/local/bin/kubectl get deployment prometheus-server -n monitoring
  register: prometheus_deployment_status
  failed_when: false
  changed_when: false
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

# 5ï¸âƒ£ Crear carpeta temporal para manifiestos de Prometheus si no existe
- name: ğŸ“ Crear carpeta temporal para manifiestos de Prometheus
  file:
    path: /tmp/prometheus_manifests
    state: directory
    mode: '0755'

# 6ï¸âƒ£ Renderizar plantilla del PVC de Prometheus
- name: ğŸ“ Renderizar plantilla del PVC de Prometheus
  template:
    src: prometheus-pvc.yaml.j2
    dest: /tmp/prometheus_manifests/prometheus-pvc.yaml

# 7ï¸âƒ£ Aplicar PVC de Prometheus vÃ­a kubectl
- name: ğŸ“¦ Aplicar PVC de Prometheus vÃ­a kubectl
  command: /usr/local/bin/kubectl apply -f /tmp/prometheus_manifests/prometheus-pvc.yaml -n monitoring
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

# 8ï¸âƒ£ Instalar Prometheus vÃ­a Helm (si no estÃ¡ instalado aÃºn)
- name: ğŸš€ Instalar Prometheus vÃ­a Helm si no estÃ¡ instalado
  command: >
    /usr/local/bin/helm install prometheus prometheus-community/prometheus
    --namespace monitoring
    --set server.persistentVolume.enabled=true
    --set server.persistentVolume.existingClaim=prometheus-pvc
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"
    KUBECONFIG: "/home/victory/.kube/config"
  args:
    chdir: /tmp
  register: install_prometheus_result
  when: prometheus_deployment_status.rc != 0
  changed_when: "'STATUS: deployed' in install_prometheus_result.stdout"

# 9ï¸âƒ£ Mostrar salida de la instalaciÃ³n de Prometheus
- name: ğŸ“œ Mostrar salida de instalaciÃ³n Helm Prometheus
  debug:
    msg: "{{ install_prometheus_result.stdout }}"
  when: prometheus_deployment_status.rc != 0

# ğŸ”Ÿ Mostrar mensaje si Prometheus ya estÃ¡ instalado
- name: âœ… Mostrar que Prometheus ya estÃ¡ instalado
  debug:
    msg: "âœ… Prometheus ya estaba instalado. No se realizÃ³ una nueva instalaciÃ³n."
  when: prometheus_deployment_status.rc == 0