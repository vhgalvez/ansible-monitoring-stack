---
# roles/prometheus/tasks/main.yml

- name: ðŸ“ Crear carpeta temporal para manifiestos si no existe
  file:
    path: /tmp/prometheus_manifests
    state: directory
    mode: '0755'

- name: ðŸ“ Renderizar plantilla del PVC de Prometheus
  template:
    src: prometheus-pvc.yaml.j2
    dest: /tmp/prometheus_manifests/prometheus-pvc.yaml

- name: ðŸ“¥ Crear namespace monitoring (si no existe)
  command: /usr/local/bin/kubectl create namespace monitoring
  register: ns_result
  failed_when: ns_result.rc != 0 and 'AlreadyExists' not in ns_result.stderr
  changed_when: "'created' in ns_result.stdout"
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

- name: ðŸ“¦ Aplicar PVC de Prometheus vÃ­a kubectl
  command: /usr/local/bin/kubectl apply -f /tmp/prometheus_manifests/prometheus-pvc.yaml -n monitoring
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

- name: ðŸ”— AÃ±adir repositorio prometheus-community si no existe
  command: /usr/local/bin/helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"
  register: add_repo_result
  failed_when: add_repo_result.rc != 0 and 'exists' not in add_repo_result.stderr
  changed_when: "'Successfully' in add_repo_result.stdout or 'has been added' in add_repo_result.stdout"

- name: ðŸ”„ Actualizar repositorios de Helm
  command: /usr/local/bin/helm repo update
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"

- name: ðŸš€ Instalar Prometheus vÃ­a Helm
  command: >
    /usr/local/bin/helm install prometheus prometheus-community/prometheus
    --namespace monitoring
    --set server.persistentVolume.enabled=true
    --set server.persistentVolume.existingClaim=prometheus-pvc
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin"
    KUBECONFIG: "/home/victory/.kube/config"
  args:
    chdir: /tmp