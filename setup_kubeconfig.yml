---
- name: 0ï¸âƒ£ Configurar acceso local al clÃºster Kubernetes (K3s)
  hosts: localhost
  gather_facts: false
  become: true
  vars:
    kubeconfig_path: "/home/victory/.kube/config"
    master_node: "10.17.4.21"
    ssh_key: "/root/.ssh/cluster_k3s/shared/id_rsa_shared_cluster"
    vip_kubernetes: "10.17.5.10"

  tasks:

    - name: ğŸ“ Crear carpeta ~/.kube si no existe
      file:
        path: "{{ kubeconfig_path | dirname }}"
        state: directory
        owner: victory
        group: victory
        mode: '0755'

    - name: ğŸ“¥ Descargar kubeconfig desde master1 usando scp (modo raw)
      raw: >
        scp -i {{ ssh_key }} -o StrictHostKeyChecking=no core@{{ master_node }}:/etc/rancher/k3s/k3s.yaml {{ kubeconfig_path }}
      delegate_to: localhost
      become: false

    - name: ğŸ” Reemplazar IP localhost por IP VIP en el kubeconfig
      replace:
        path: "{{ kubeconfig_path }}"
        regexp: '127\.0\.0\.1'
        replace: "{{ vip_kubernetes }}"

    - name: ğŸ”§ Eliminar certificate-authority-data del kubeconfig
      lineinfile:
        path: "{{ kubeconfig_path }}"
        regexp: '^\s*certificate-authority-data:'
        state: absent

    - name: âš ï¸ AÃ±adir insecure-skip-tls-verify al bloque del cluster
      blockinfile:
        path: "{{ kubeconfig_path }}"
        marker: "# {mark} Ansible skip TLS"
        insertafter: '^    server: https://{{ vip_kubernetes }}:6443'
        block: |
          insecure-skip-tls-verify: true

    - name: ğŸ” Cambiar permisos del kubeconfig
      file:
        path: "{{ kubeconfig_path }}"
        owner: victory
        group: victory
        mode: '0600'

    - name: ğŸ§ª Verificar acceso al clÃºster (kubectl get nodes)
      command: /usr/local/bin/kubectl get nodes
      environment:
        KUBECONFIG: "{{ kubeconfig_path }}"
      register: nodes_output
      failed_when: nodes_output.rc != 0
      changed_when: false

    - name: ğŸ“Š Mostrar salida de kubectl
      debug:
        msg: "{{ nodes_output.stdout }}"