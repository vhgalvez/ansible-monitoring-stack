---
# üîÅ Playbook maestro para desinstalar completamente el stack de monitoreo
# Incluye: eliminaci√≥n de Helm releases, PVCs, servicios, pods y namespace

- name: üßº Eliminar stack de monitoreo (Grafana + Prometheus)
  hosts: localhost
  become: yes
  gather_facts: false
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

  tasks:

    # 1Ô∏è‚É£ Verificar si el namespace 'monitoring' existe
    - name: üîç Comprobar existencia del namespace 'monitoring'
      command: /usr/local/bin/kubectl get namespace monitoring
      register: ns_check
      failed_when: false
      changed_when: false

    # 2Ô∏è‚É£ Desinstalar Helm release de Prometheus
    - name: ‚ùå Desinstalar Prometheus con Helm
      command: /usr/local/bin/helm uninstall prometheus -n monitoring
      when: ns_check.rc == 0
      register: uninstall_prometheus
      failed_when: false
      changed_when: "'uninstalled' in uninstall_prometheus.stdout"

    # 3Ô∏è‚É£ Desinstalar Helm release de Grafana
    - name: ‚ùå Desinstalar Grafana con Helm
      command: /usr/local/bin/helm uninstall grafana -n monitoring
      when: ns_check.rc == 0
      register: uninstall_grafana
      failed_when: false
      changed_when: "'uninstalled' in uninstall_grafana.stdout"

    # 4Ô∏è‚É£ Eliminar PVCs de Grafana y Prometheus
    - name: üßπ Eliminar PVCs de Grafana y Prometheus
      command: /usr/local/bin/kubectl delete pvc grafana-pvc prometheus-pvc -n monitoring
      when: ns_check.rc == 0
      failed_when: false

    # 5Ô∏è‚É£ Eliminar recursos de Longhorn (si fueron etiquetados)
    - name: üßº Eliminar PVCs de Longhorn con etiqueta app=longhorn
      command: /usr/local/bin/kubectl delete pvc -l app=longhorn -n monitoring
      when: ns_check.rc == 0
      failed_when: false

    # 6Ô∏è‚É£ Eliminar el namespace de monitoreo
    - name: üß® Eliminar namespace 'monitoring'
      command: /usr/local/bin/kubectl delete namespace monitoring
      when: ns_check.rc == 0
      failed_when: false
      register: ns_delete

    # 7Ô∏è‚É£ Mensaje final de limpieza
    - name: ‚úÖ Confirmaci√≥n de limpieza completa
      debug:
        msg: "üßΩ Stack de monitoreo eliminado correctamente."