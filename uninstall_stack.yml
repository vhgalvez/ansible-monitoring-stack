---
# uninstall_stack.yml
# ğŸ§¼ Playbook para eliminar por completo Prometheus + Grafana + namespace

- name: ğŸ§¼ Eliminar stack de monitoreo (Prometheus + Grafana)
  hosts: controller
  become: true
  gather_facts: false
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

  vars:
    namespace: monitoring

  tasks:

    - name: ğŸ” Verificar si el namespace '{{ namespace }}' existe
      command: kubectl get namespace {{ namespace }}
      register: ns_check
      failed_when: false
      changed_when: false

    - name: âŒ Desinstalar Prometheus con Helm
      command: helm uninstall prometheus -n {{ namespace }}
      when: ns_check.rc == 0
      ignore_errors: true

    - name: âŒ Desinstalar Grafana con Helm
      command: helm uninstall grafana -n {{ namespace }}
      when: ns_check.rc == 0
      ignore_errors: true

    - name: ğŸ§½ Eliminar todos los recursos comunes del namespace
      shell: |
        kubectl delete pvc,svc,pod,secret,configmap --all -n {{ namespace }} --ignore-not-found=true
      when: ns_check.rc == 0
      ignore_errors: true

    - name: âŒ Eliminar namespace '{{ namespace }}'
      command: kubectl delete namespace {{ namespace }} --ignore-not-found=true
      when: ns_check.rc == 0
      ignore_errors: true

    - name: ğŸ’¤ Esperar a que namespace entre en terminaciÃ³n (si aplica)
      pause:
        seconds: 10
      when: ns_check.rc == 0

    - name: ğŸ“¦ Verificar si jq estÃ¡ instalado para eliminar finalizers
      command: which jq
      register: jq_check
      failed_when: jq_check.rc != 0
      changed_when: false

    - name: ğŸ›  Forzar eliminaciÃ³n de finalizers si el namespace sigue colgado
      shell: |
        kubectl get namespace {{ namespace }} -o json \
        | jq 'del(.spec.finalizers)' \
        | kubectl replace --raw "/api/v1/namespaces/{{ namespace }}/finalize" -f -
      when:
        - ns_check.rc == 0
        - final_check.rc == 0
        - jq_check.rc == 0
      ignore_errors: true
      register: force_delete

    - name: âœ… Verificar que el namespace fue eliminado
      shell: kubectl get namespace {{ namespace }}
      register: final_check
      failed_when: false
      changed_when: false

    - name: âœ… ConfirmaciÃ³n de limpieza completa
      debug:
        msg: "ğŸ§½ Stack de monitoreo y namespace '{{ namespace }}' eliminados correctamente."
      when: final_check.rc != 0

    - name: âš ï¸ El namespace sigue existiendo
      debug:
        msg: "ğŸš¨ AtenciÃ³n: El namespace '{{ namespace }}' aÃºn existe. Revisa CRDs o finalizers manualmente."
      when: final_check.rc == 0