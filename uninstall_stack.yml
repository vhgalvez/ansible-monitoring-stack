---
# ğŸ§¼ uninstall_stack.yml
# DesinstalaciÃ³n completa del stack de monitoreo (Prometheus + Grafana) y sus recursos asociados

- name: ğŸ§¼ Eliminar stack de monitoreo (Prometheus + Grafana)
  hosts: controller
  become: true
  gather_facts: false
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

  vars:
    namespace: monitoring

  tasks:

    - name: ğŸ” Verificar si el namespace '{{ namespace }}' existe
      command: kubectl get namespace {{ namespace }}
      register: ns_check
      failed_when: false
      changed_when: false

    - name: âŒ Desinstalar Prometheus con Helm
      command: helm uninstall prometheus -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false
      ignore_errors: true

    - name: âŒ Desinstalar Grafana con Helm
      command: helm uninstall grafana -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false
      ignore_errors: true

    - name: ğŸ§¹ Eliminar todos los PVCs del namespace
      command: kubectl delete pvc --all -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false
      ignore_errors: true

    - name: âŒ Eliminar todos los servicios del namespace
      command: kubectl delete svc --all -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false
      ignore_errors: true

    - name: âŒ Eliminar todos los pods del namespace
      command: kubectl delete pod --all -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false
      ignore_errors: true

    - name: âŒ Eliminar ConfigMaps y Secrets
      command: kubectl delete secret --all -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false
      ignore_errors: true

    - name: âŒ Eliminar namespace '{{ namespace }}'
      command: kubectl delete namespace {{ namespace }}
      when: ns_check.rc == 0
      register: ns_delete
      failed_when: false
      changed_when: ns_delete.rc == 0

    - name: âœ… ConfirmaciÃ³n de limpieza completa
      debug:
        msg: "ğŸ§½ Stack de monitoreo eliminado correctamente."
      when: ns_check.rc == 0

    - name: â„¹ï¸ El namespace '{{ namespace }}' no existÃ­a
      debug:
        msg: "âœ… El namespace '{{ namespace }}' no existe o ya fue eliminado."
      when: ns_check.rc != 0