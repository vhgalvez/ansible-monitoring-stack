---
# üßº deploy_monitoring_stack.yml
# Desinstala completamente el stack de monitoreo: Helm releases, PVCs, Pods, Servicios, Namespace y recursos de Longhorn

- name: üßº Eliminar stack de monitoreo (Grafana + Prometheus)
  hosts: localhost
  become: yes
  gather_facts: false
  environment:
    KUBECONFIG: "/home/victory/.kube/config"

  vars:
    namespace: monitoring

  tasks:
    # 1Ô∏è‚É£ Comprobar si el namespace existe
    - name: üîç Verificar existencia del namespace "{{ namespace }}"
      command: kubectl get namespace {{ namespace }}
      register: ns_check
      failed_when: false
      changed_when: false

    # 2Ô∏è‚É£ Desinstalar Prometheus si est√° presente
    - name: ‚ùå Desinstalar Prometheus con Helm
      command: helm uninstall prometheus -n {{ namespace }}
      when: ns_check.rc == 0
      register: uninstall_prometheus
      failed_when: false
      changed_when: "'uninstalled' in uninstall_prometheus.stdout"

    # 3Ô∏è‚É£ Desinstalar Grafana si est√° presente
    - name: ‚ùå Desinstalar Grafana con Helm
      command: helm uninstall grafana -n {{ namespace }}
      when: ns_check.rc == 0
      register: uninstall_grafana
      failed_when: false
      changed_when: "'uninstalled' in uninstall_grafana.stdout"

    # 4Ô∏è‚É£ Eliminar PVCs principales
    - name: üßπ Eliminar PVCs de Grafana y Prometheus
      command: kubectl delete pvc grafana-pvc prometheus-pvc -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false

    # 5Ô∏è‚É£ Eliminar PVCs con etiqueta app=longhorn
    - name: üßº Eliminar PVCs de Longhorn con label app=longhorn
      command: kubectl delete pvc -l app=longhorn -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false

    # 6Ô∏è‚É£ Eliminar servicios si existen (Prometheus)
    - name: ‚ùå Eliminar servicios de Prometheus si existen
      command: >
        kubectl delete service prometheus-server
        prometheus-alertmanager
        prometheus-kube-state-metrics
        prometheus-prometheus-node-exporter
        prometheus-prometheus-pushgateway -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false

    # 7Ô∏è‚É£ Eliminar Pods (por etiqueta)
    - name: ‚ùå Eliminar Pods de Grafana y Prometheus
      command: kubectl delete pod -l app in (grafana,prometheus) -n {{ namespace }}
      when: ns_check.rc == 0
      failed_when: false

    # 8Ô∏è‚É£ Eliminar el namespace
    - name: üß® Eliminar namespace "{{ namespace }}"
      command: kubectl delete namespace {{ namespace }}
      when: ns_check.rc == 0
      register: ns_delete
      failed_when: false

    # 9Ô∏è‚É£ Confirmaci√≥n final
    - name: ‚úÖ Confirmaci√≥n de limpieza completa
      debug:
        msg: "üßΩ Stack de monitoreo eliminado correctamente."

    - name: ‚ÑπÔ∏è Namespace no exist√≠a previamente
      debug:
        msg: "‚úÖ El namespace '{{ namespace }}' no existe o ya fue eliminado."
      when: ns_check.rc != 0
