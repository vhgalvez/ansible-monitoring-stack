---
# ðŸ“ Archivo: update_node_monitoring.yml
# ðŸ”„ Actualiza node_exporter en hosts externos y actualiza el Secret en Prometheus

- name: ðŸ”„ Actualizar monitoreo de nodos externos
  hosts: localhost
  gather_facts: false
  become: true
  tasks:
    - name: ðŸ” Ejecutar instalaciÃ³n de Node Exporter
      import_playbook: playbooks/04_install_node_exporter.yml

    - name: ðŸ“„ Generar archivo de configuraciÃ³n de scrapes
      import_playbook: playbooks/05_update_scrape_targets.yml

    - name: ðŸ” Aplicar Secret actualizado de scrape configs
      vars:
        secret_file: "/tmp/prometheus_manifests/extraScrapeConfigs.yaml"
      block:
        - name: ðŸ” Crear o actualizar Secret en Kubernetes
          command: >
            kubectl create secret generic prometheus-additional-scrape-configs \
              --from-file=extraScrapeConfigs.yaml={{ secret_file }} \
              --namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
          environment:
            KUBECONFIG: "/home/victory/.kube/config"

        - name: âœ… Mostrar mensaje de actualizaciÃ³n exitosa
          debug:
            msg: "âœ… Secret actualizado correctamente con nuevos scrape targets."
